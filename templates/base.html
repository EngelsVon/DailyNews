<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>每日消息站</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="{{ url_for('static', filename='styles.css') }}" rel="stylesheet">
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-light bg-light" id="topNav">
  <div class="container-fluid">
    <a class="navbar-brand" href="{{ url_for('index') }}">每日消息站</a>
    <div class="d-flex align-items-center gap-2">
      <div class="dropdown me-2">
        <button class="btn btn-outline-light dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
          主题
        </button>
        <ul class="dropdown-menu dropdown-menu-end">
          <li><a class="dropdown-item" href="#" onclick="return setTheme('default')">默认</a></li>
          <li><a class="dropdown-item" href="#" onclick="return setTheme('theme-sci')">科幻 HUD</a></li>
        </ul>
      </div>
      <a class="btn btn-outline-light me-2" href="{{ url_for('manage_sections') }}">管理板块</a>
      <a class="btn btn-outline-light" href="{{ url_for('settings') }}">设置</a>
    </div>
  </div>
</nav>
<div class="container py-4">
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ 'danger' if category=='error' else category }} alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}
  {% block content %}{% endblock %}
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
(function applyStoredTheme(){
  try{
    const key = 'dn_theme';
    const cls = localStorage.getItem(key);
    const nav = document.getElementById('topNav');
    const allowed = new Set(['theme-sci']);
    function applyNavbarTheme(hasDark){
      if(!nav) return;
      if(hasDark){
        nav.classList.add('navbar-dark','bg-dark');
        nav.classList.remove('navbar-light','bg-light');
      } else {
        nav.classList.remove('navbar-dark','bg-dark');
        nav.classList.add('navbar-light','bg-light');
      }
    }
    // 移除页面上残留的 theme-* 类（包括旧的 theme-3d）
    Array.from(document.body.classList).forEach(c => { if(c && c.indexOf('theme-') === 0){ document.body.classList.remove(c); } });
    if(cls && allowed.has(cls)){
      document.body.classList.add(cls);
      applyNavbarTheme(true);
    } else {
      // 如本地存储是过期主题（如 theme-3d），回退为 default
      if(cls && cls !== 'default' && !allowed.has(cls)){
        localStorage.setItem(key, 'default');
      }
      applyNavbarTheme(false);
    }
    window.setTheme = function(cls){
      try{
        // 移除所有 theme-* 类，避免残留
        Array.from(document.body.classList).forEach(c => { if(c && c.indexOf('theme-') === 0){ document.body.classList.remove(c); } });
        if(cls && cls !== 'default' && allowed.has(cls)){
          document.body.classList.add(cls);
          localStorage.setItem(key, cls);
          applyNavbarTheme(true);
        } else {
          localStorage.setItem(key, 'default');
          applyNavbarTheme(false);
        }
        // 关闭下拉菜单，避免覆盖层影响后续点击
        const toggle = document.querySelector('#topNav [data-bs-toggle="dropdown"]');
        if(toggle && window.bootstrap && window.bootstrap.Dropdown){
          const inst = window.bootstrap.Dropdown.getInstance(toggle) || new window.bootstrap.Dropdown(toggle);
          inst.hide();
          // 强制移除 Bootstrap 可能遗留的 backdrop 覆盖层
          setTimeout(() => {
            const backdrops = document.querySelectorAll('.dropdown-backdrop');
            backdrops.forEach(bd => bd.remove());
            // 确保 body 没有被 Bootstrap 添加的覆盖样式
            document.body.style.removeProperty('pointer-events');
          }, 50);
        }
      }catch(e){ console.warn('setTheme failed', e); }
      return false; // 阻止 href="#" 的默认行为
    }
  }catch(e){ console.warn('theme init failed', e); }
})();
function postJSON(url, data={}, method='POST', options={}){
  const { signal } = options || {};
  return fetch(url, { method, headers: { 'Content-Type': 'application/json' }, body: method === 'GET' ? undefined : JSON.stringify(data), signal })
    .then(async (r) => {
      const ct = r.headers.get('content-type') || '';
      if (ct.includes('application/json')) {
        try { 
          const result = await r.json(); 
          return { ...result, ok: r.ok, status: r.status };
        } catch (e) { 
          const text = await r.text();
          return { ok: false, status: r.status, error: 'JSON parse error', text };
        }
      }
      const text = await r.text();
      return { ok: r.ok, status: r.status, error: 'Non-JSON response', text };
    })
    .catch((err) => ({ ok: false, error: (err && err.name === 'AbortError') ? 'Request cancelled' : ((err && err.message) || String(err)) }));
}
</script>
<!-- 将 Toast 容器移动到底部右侧，避免遮挡右上角主题下拉菜单 -->
<div class="toast-container position-fixed bottom-0 end-0 p-3" id="toastContainer" style="z-index:1080; pointer-events: none;"></div>
<script>
function notify(message, type='info', delay=2500){
  try{
    const container = document.getElementById('toastContainer');
    const el = document.createElement('div');
    el.className = `toast text-bg-${type} border-0`;
    el.setAttribute('role','alert');
    el.setAttribute('aria-live','assertive');
    el.setAttribute('aria-atomic','true');
    el.style.pointerEvents = 'auto'; // 允许与Toast交互（关闭按钮等）
    el.innerHTML = `<div class=\"d-flex\"><div class=\"toast-body\">${message}</div><button type=\"button\" class=\"btn-close btn-close-white me-2 m-auto\" data-bs-dismiss=\"toast\" aria-label=\"Close\"></button></div>`;
    container.appendChild(el);
    const t = new bootstrap.Toast(el, { delay });
    t.show();
    el.addEventListener('hidden.bs.toast',()=>{ el.remove(); });
  }catch(e){
    try{ alert(message); }catch(_){ console.log(message); }
  }
}

function setLoading(btn, loading, loadingText){
  if(!btn) return;
  if(loading){
    btn.disabled = true;
    if(!btn.dataset.origText){ btn.dataset.origText = btn.innerHTML; }
    btn.innerHTML = `<span class=\"spinner-border spinner-border-sm me-2\" role=\"status\" aria-hidden=\"true\"></span>${loadingText || '处理中...'}`;
  } else {
    btn.disabled = false;
    if(btn.dataset.origText){ btn.innerHTML = btn.dataset.origText; delete btn.dataset.origText; }
  }
}
</script>
{% block scripts %}{% endblock %}
</body>
</html>